<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-left">
      <h1>Welcome back, {{ currentUser?.name }}! ğŸ‘‹</h1>
      <p class="subtitle">Here's what's happening with your household today</p>
    </div>
    <div class="header-actions" *ngIf="isHouseholdAdmin()">
      <button mat-raised-button color="primary" (click)="openCreateTaskDialog()" class="header-create-btn">
        <mat-icon>add</mat-icon> Create Task
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading" class="dashboard-content">
    
    <!-- Stats Cards Row -->
    <div class="stats-row">
      <mat-card class="stat-card points-card">
        <div class="stat-icon">ğŸ†</div>
        <div class="stat-info">
          <h2>{{ stats.totalPoints }}</h2>
          <p>Total Points</p>
        </div>
      </mat-card>

      <mat-card class="stat-card streak-card">
        <div class="stat-icon">ğŸ”¥</div>
        <div class="stat-info">
          <h2>{{ stats.streakDays }} Days</h2>
          <p>Current Streak</p>
        </div>
      </mat-card>

      <mat-card class="stat-card tasks-card">
        <div class="stat-icon">âœ…</div>
        <div class="stat-info">
          <h2>{{ stats.completedTasks }}</h2>
          <p>Completed Tasks</p>
        </div>
      </mat-card>

      <mat-card class="stat-card pending-card">
        <div class="stat-icon">ğŸ“‹</div>
        <div class="stat-info">
          <h2>{{ stats.pendingTasks }}</h2>
          <p>Pending Tasks</p>
        </div>
      </mat-card>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
      
      <!-- Tasks Section -->
      <div class="tasks-section">
        <mat-card class="section-card">
          <mat-card-header>
            <mat-card-title>Your Tasks</mat-card-title>
            <!-- Create Task button for admins 
            <button mat-raised-button color="accent" class="create-task-btn" 
                    *ngIf="isHouseholdAdmin()"
                    (click)="openCreateTaskDialog()">
              <mat-icon>add</mat-icon> Create Task
            </button>-->
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="getTasksByStatus('pending').length === 0" class="empty-state">
              <p>ğŸ‰ No pending tasks! You're all caught up!</p>
              <!--<button mat-raised-button color="primary" 
                      *ngIf="isHouseholdAdmin()"
                      (click)="openCreateTaskDialog()">
                Create Your First Task
              </button>-->
            </div>
            
            <div *ngFor="let task of getTasksByStatus('pending')" class="task-item">
              <div class="task-header">
                <div class="task-title-row">
                  <span class="task-priority-dot" 
                        [style.background-color]="getPriorityColor(task.priority)"></span>
                  <h3>{{ task.title }}</h3>
                </div>
                <span class="task-points">+{{ task.points }} pts</span>
              </div>
              
              <p class="task-description" *ngIf="task.description">
                {{ task.description }}
              </p>
              
              <div class="task-footer">
                <mat-chip class="category-chip">{{ task.category }}</mat-chip>
                <span class="task-assigned" *ngIf="task.assignedTo">
                  Assigned to: {{ task.assignedTo.name }}
                </span>
              </div>
              
              <div class="task-actions">
                <button mat-raised-button color="primary" 
                        *ngIf="canCompleteTask(task)"
                        (click)="completeTask(task._id)">
                  Mark Complete
                </button>
                <span *ngIf="!canCompleteTask(task)" class="not-assigned-msg">
                  Assigned to {{ task.assignedTo?.name }}
                </span>
                <button mat-button color="accent" 
                        *ngIf="isHouseholdAdmin()"
                        (click)="openEditTaskDialog(task)">
                  <mat-icon>edit</mat-icon> Edit
                </button>
                <button mat-button color="warn" 
                        *ngIf="isHouseholdAdmin()"
                        (click)="deleteTask(task._id)">
                  <mat-icon>delete</mat-icon> Delete
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
         <!-- Completed Tasks Section - Collapsible -->
        <mat-card class="section-card" style="margin-top: 20px;">
          <mat-card-header (click)="toggleCompletedTasks()" style="cursor: pointer;">
            <mat-card-title style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <span>Completed Tasks ({{ getTasksByStatus('completed').length }})</span>
              <mat-icon>{{ completedTasksExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
            </mat-card-title>
          </mat-card-header>
          
          <mat-card-content *ngIf="completedTasksExpanded">
            <!-- Filters -->
            <div class="completed-filters">
              <mat-form-field appearance="outline" style="margin-right: 15px;">
                <mat-label>Sort By</mat-label>
                <select matNativeControl [(ngModel)]="completedTasksSort">
                  <option value="date">Date (Newest First)</option>
                  <option value="person">Person (A-Z)</option>
                </select>
              </mat-form-field>
              
              <mat-form-field appearance="outline">
                <mat-label>Filter by Person</mat-label>
                <select matNativeControl [(ngModel)]="selectedPersonFilter">
                  <option value="all">All Members</option>
                  <option *ngFor="let member of householdMembers" [value]="member._id || member.id">
                    {{ member.name }}
                  </option>
                </select>
              </mat-form-field>
            </div>
            </mat-card-content>
            </mat-card>
            
            <!-- Completed Tasks List with Scroll -->
            <div class="completed-tasks-container">
              <div *ngIf="getSortedCompletedTasks().length === 0" class="empty-state">
                <p>No completed tasks match your filters.</p>
              </div>
              
              <div *ngFor="let task of getSortedCompletedTasks()" class="task-item completed-task">
                <div class="task-header">
                  <div class="task-title-row">
                    <span class="task-priority-dot" 
                          [style.background-color]="getPriorityColor(task.priority)"></span>
                    <h3>{{ task.title }}</h3>
                    <span style="margin-left: 10px; color: #4caf50; font-weight: bold;">âœ“ Completed</span>
                  </div>
                  <span class="task-points" style="color: #4caf50;">+{{ task.points }} pts</span>
                </div>
                
                <p class="task-description" *ngIf="task.description">
                  {{ task.description }}
                </p>
                
                <div class="task-footer">
                  <mat-chip class="category-chip">{{ task.category }}</mat-chip>
                  
                  <span class="task-assigned" *ngIf="task.assignedTo">
                    Assigned to: {{ task.assignedTo.name }}
                  </span>
                  
                  <span class="task-completed-by" *ngIf="task.completedBy" style="margin-left: 15px; color: #666;">
                    <strong>Completed by:</strong> {{ task.completedBy.name }}
                  </span>
                  
                  <span *ngIf="task.completedAt" style="margin-left: 15px; color: #666; font-size: 14px;">
                    <strong>Completed:</strong> {{ task.completedAt | date:'short' }}
                  </span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        
        <!-- Badges Section -->
        <mat-card class="section-card badges-card">
          <mat-card-header>
            <mat-card-title>Your Badges ğŸ…</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="currentUser && currentUser.badges && currentUser.badges.length > 0" class="badges-grid">
              <div *ngFor="let badge of currentUser.badges" class="badge-item">
                <div class="badge-icon">ğŸ…</div>
                <div class="badge-name">{{ badge.name }}</div>
              </div>
            </div>
            <div *ngIf="!currentUser || !currentUser.badges || currentUser.badges.length === 0" class="empty-state">
              <p>Complete tasks to earn badges!</p>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Leaderboard Section -->
        <mat-card class="section-card leaderboard-card" *ngIf="household">
          <mat-card-header>
            <mat-card-title>Household Leaderboard ğŸ“Š</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngFor="let member of leaderboard; let i = index" class="leaderboard-item">
              <div class="rank">
                <span *ngIf="i === 0" class="rank-emoji">ğŸ¥‡</span>
                <span *ngIf="i === 1" class="rank-emoji">ğŸ¥ˆ</span>
                <span *ngIf="i === 2" class="rank-emoji">ğŸ¥‰</span>
                <span *ngIf="i > 2" class="rank-number">{{ i + 1 }}</span>
              </div>
              <div class="member-info">
                <div class="member-name">{{ member.name }}</div>
                <div class="member-points">{{ member.points }} points</div>
              </div>
              <div class="member-streak" *ngIf="member.streakDays > 0">
                ğŸ”¥ {{ member.streakDays }}
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- No Household Message -->
        <mat-card class="section-card" *ngIf="!household">
          <mat-card-content>
            <div class="no-household">
              <h3>No Household Yet</h3>
              <p>Create or join a household to start collaborating!</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </div>
</div>  

<!-- Create/Edit Task Dialog -->
<div class="task-dialog-overlay" *ngIf="showCreateTask" (click)="closeCreateTaskDialog()">
  <div class="task-dialog" (click)="$event.stopPropagation()">
    <h2>{{ editingTask ? 'Edit Task' : 'Create New Task' }}</h2>
    
    <form class="task-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Task Title</mat-label>
        <input matInput [(ngModel)]="newTask.title" name="title" placeholder="e.g., Clean the kitchen" required>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput [(ngModel)]="newTask.description" name="description" rows="3" placeholder="Add details..."></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Priority</mat-label>
        <select matNativeControl [(ngModel)]="newTask.priority" name="priority" id="priority" aria-label="Task priority">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Category</mat-label>
        <select matNativeControl [(ngModel)]="newTask.category" name="category" id="category" aria-label="Task category">
          <option value="cleaning">Cleaning</option>
          <option value="cooking">Cooking</option>
          <option value="shopping">Shopping</option>
          <option value="maintenance">Maintenance</option>
          <option value="childcare">Childcare</option>
          <option value="petcare">Pet Care</option>
          <option value="other">Other</option>
        </select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width" *ngIf="householdMembers.length > 0">
        <mat-label>Assign To (Optional)</mat-label>
        <select matNativeControl [(ngModel)]="newTask.assignedTo" name="assignedTo" id="assignedTo" aria-label="Assign task to household member">
          <option value="">Auto-assign</option>
          <option *ngFor="let member of householdMembers" [value]="member._id || member.id">{{ member.name }}</option>
        </select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Due Date (Optional)</mat-label>
        <input matInput type="date" [(ngModel)]="newTask.dueDate" name="dueDate">
      </mat-form-field>

      <div class="dialog-actions">
        <button mat-button type="button" (click)="closeCreateTaskDialog()">Cancel</button>
        <button mat-raised-button color="primary" type="button"
                *ngIf="!editingTask"
                (click)="createTask()">
          Create Task
        </button>
        <button mat-raised-button color="primary" type="button"
                *ngIf="editingTask"
                (click)="updateTask()">
          Update Task
        </button>
      </div>
    </form>
  </div>
</div>
